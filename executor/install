#!/usr/bin/env bash
set -euo pipefail

APP="executor"
REPO="${EXECUTOR_REPO:-RhysSullivan/executor}"
INSTALL_DIR="${EXECUTOR_INSTALL_DIR:-$HOME/.executor/bin}"
WEB_INSTALL_DIR="${EXECUTOR_WEB_INSTALL_DIR:-$HOME/.executor/runtime/web}"
REQUESTED_VERSION="${VERSION:-}"
RESOLVED_VERSION=""
BINARY_PATH=""
NO_MODIFY_PATH="0"
STAR_PROMPT="1"
SCRIPT_FILE="${BASH_SOURCE[0]:-$0}"
SCRIPT_DIR="$(cd -- "$(dirname -- "${SCRIPT_FILE}")" >/dev/null 2>&1 && pwd)"
LOCAL_BINARY_CANDIDATE="$SCRIPT_DIR/dist/executor"
LOCAL_WEB_CANDIDATE="$SCRIPT_DIR/dist/release"

RED='\033[0;31m'
MUTED='\033[0;2m'
NC='\033[0m'

usage() {
  cat <<EOF
Executor installer

Usage:
  curl -fsSL https://executor.sh/install | bash

Options:
  -v, --version <version>  Install specific release tag (with or without leading v)
  -b, --binary <path>      Install from a local prebuilt binary
  --no-star-prompt         Do not show GitHub star prompt
  --no-modify-path         Do not append executor bin directory to shell rc
  -h, --help               Show this help

Environment:
  EXECUTOR_REPO            GitHub repository to install from (default: RhysSullivan/executor)
  EXECUTOR_INSTALL_DIR     Install directory (default: ~/.executor/bin)
  EXECUTOR_WEB_INSTALL_DIR Web bundle directory (default: ~/.executor/runtime/web)
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    -v|--version)
      REQUESTED_VERSION="${2:-}"
      if [[ -z "$REQUESTED_VERSION" ]]; then
        echo -e "${RED}Missing value for --version${NC}"
        exit 1
      fi
      shift 2
      ;;
    -b|--binary)
      BINARY_PATH="${2:-}"
      if [[ -z "$BINARY_PATH" ]]; then
        echo -e "${RED}Missing value for --binary${NC}"
        exit 1
      fi
      shift 2
      ;;
    --no-modify-path)
      NO_MODIFY_PATH="1"
      shift
      ;;
    --no-star-prompt)
      STAR_PROMPT="0"
      shift
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      exit 1
      ;;
  esac
done

if [[ -n "$REQUESTED_VERSION" ]]; then
  RESOLVED_VERSION="${REQUESTED_VERSION#v}"
fi

raw_os="$(uname -s)"
case "$raw_os" in
  Linux*) os="linux" ;;
  Darwin*) os="darwin" ;;
  *)
    echo -e "${RED}Unsupported OS: ${raw_os}${NC}"
    exit 1
    ;;
esac

raw_arch="$(uname -m)"
case "$raw_arch" in
  x86_64|amd64) arch="x64" ;;
  arm64|aarch64) arch="arm64" ;;
  *)
    echo -e "${RED}Unsupported architecture: ${raw_arch}${NC}"
    exit 1
    ;;
esac

archive_ext="tar.gz"

filename="${APP}-${os}-${arch}.${archive_ext}"
web_filename="executor-web-${os}-${arch}.tar.gz"
mkdir -p "$INSTALL_DIR"
mkdir -p "$WEB_INSTALL_DIR"

install_local_binary() {
  local src="$1"
  local tmp_target
  if [[ ! -f "$src" ]]; then
    echo -e "${RED}Local binary not found: ${src}${NC}"
    exit 1
  fi
  tmp_target="$INSTALL_DIR/.${APP}.tmp.$$"
  cp "$src" "$tmp_target"
  chmod 755 "$tmp_target"
  mv -f "$tmp_target" "$INSTALL_DIR/$APP"
}

install_web_bundle_from_archive() {
  local archive_path="$1"
  local tmp_web_dir
  tmp_web_dir="$(mktemp -d)"
  if ! tar -xzf "$archive_path" -C "$tmp_web_dir"; then
    rm -rf "$tmp_web_dir"
    echo -e "${RED}Failed extracting web archive${NC}"
    exit 1
  fi
  if [[ ! -f "$tmp_web_dir/server.js" ]]; then
    rm -rf "$tmp_web_dir"
    echo -e "${RED}Web archive missing expected server.js entry${NC}"
    exit 1
  fi

  rm -rf "$WEB_INSTALL_DIR"
  mkdir -p "$WEB_INSTALL_DIR"
  cp -R "$tmp_web_dir"/. "$WEB_INSTALL_DIR"
  rm -rf "$tmp_web_dir"
}

install_web_bundle() {
  local web_url
  local temp_archive
  temp_archive="$(mktemp)"

  if [[ -z "$REQUESTED_VERSION" ]]; then
    web_url="https://github.com/${REPO}/releases/latest/download/${web_filename}"
  else
    web_url="https://github.com/${REPO}/releases/download/v${RESOLVED_VERSION}/${web_filename}"
  fi

  if curl -fsSL "$web_url" -o "$temp_archive"; then
    echo -e "${MUTED}Installing web bundle${NC} ${web_filename}"
    install_web_bundle_from_archive "$temp_archive"
    rm -f "$temp_archive"
    return
  fi
  rm -f "$temp_archive"

  local local_web_archive="$LOCAL_WEB_CANDIDATE/${web_filename}"
  if [[ -f "$local_web_archive" ]]; then
    echo -e "${MUTED}Web bundle release asset not found; using local archive at ${local_web_archive}${NC}"
    install_web_bundle_from_archive "$local_web_archive"
    return
  fi

  echo -e "${RED}Web bundle was not installed (missing release asset ${web_filename})${NC}"
  echo ""
  echo "To build and install it locally:"
  echo "  bun run --cwd executor build:release"
  echo "  bash executor/install --no-modify-path"
}

if [[ -n "$BINARY_PATH" ]]; then
  echo -e "${MUTED}Installing ${APP}${NC} from local binary: $BINARY_PATH"
  install_local_binary "$BINARY_PATH"
else
  if [[ -z "$REQUESTED_VERSION" ]]; then
    url="https://github.com/${REPO}/releases/latest/download/${filename}"
    release_json="$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" 2>/dev/null || true)"
    version="$(printf "%s" "$release_json" | sed -n 's/.*"tag_name": *"\([^"]*\)".*/\1/p')"
    if [[ -z "$version" ]]; then
      version="latest"
    fi
    RESOLVED_VERSION="${version#v}"
  else
    version="${REQUESTED_VERSION#v}"
    RESOLVED_VERSION="$version"
    url="https://github.com/${REPO}/releases/download/v${version}/${filename}"
  fi

  tmp_dir="$(mktemp -d)"
  trap 'rm -rf "$tmp_dir"' EXIT

  echo -e "${MUTED}Installing ${APP}${NC} ${version:-latest}"
  if ! curl -fsSL "$url" -o "$tmp_dir/$filename"; then
    if [[ -f "$LOCAL_BINARY_CANDIDATE" ]]; then
      echo -e "${MUTED}Release asset not found; using local binary at ${LOCAL_BINARY_CANDIDATE}${NC}"
      install_local_binary "$LOCAL_BINARY_CANDIDATE"
    else
      echo -e "${RED}Could not download release asset: ${url}${NC}"
      echo ""
      echo "If you are developing locally, build and install from source:"
      echo "  bun run --cwd executor build:binary"
      echo "  bash executor/install --binary executor/dist/executor"
      exit 1
    fi
  else
    tar -xzf "$tmp_dir/$filename" -C "$tmp_dir"

    if [[ ! -f "$tmp_dir/$APP" ]]; then
      echo -e "${RED}Archive did not contain expected binary '${APP}'${NC}"
      exit 1
    fi

    mv "$tmp_dir/$APP" "$INSTALL_DIR/$APP"
    chmod 755 "$INSTALL_DIR/$APP"
  fi
fi

show_star_prompt() {
  local repo_url
  local star_cmd
  repo_url="https://github.com/${REPO}"
  star_cmd="gh api --method PUT /user/starred/${REPO}"

  if [[ "$STAR_PROMPT" != "1" ]]; then
    return
  fi

  if command -v gh >/dev/null 2>&1; then
    echo "If Executor helps, star with GitHub CLI â­:"
    echo "  ${star_cmd}"
  else
    echo "If Executor helps, please star: ${repo_url}"
  fi
}

install_web_bundle

if [[ "$NO_MODIFY_PATH" != "1" ]]; then
  shell_name="$(basename "${SHELL:-}")"
  case "$shell_name" in
    zsh) shell_rc="$HOME/.zshrc" ;;
    bash) shell_rc="$HOME/.bashrc" ;;
    *) shell_rc="$HOME/.profile" ;;
  esac

  export_line="export PATH=${INSTALL_DIR}:\$PATH"
  if [[ -f "$shell_rc" ]]; then
    if ! grep -Fxq "$export_line" "$shell_rc"; then
      printf "\n# executor\n%s\n" "$export_line" >> "$shell_rc"
    fi
  fi
fi

echo ""
echo "Installed to: $INSTALL_DIR/$APP"
if [[ -f "$WEB_INSTALL_DIR/server.js" ]]; then
  echo "Web bundle installed to: $WEB_INSTALL_DIR"
fi
echo "Run:"
echo "  executor doctor"
echo "  executor up"
echo "  executor web       # defaults to http://localhost:5312"
echo ""
echo "To uninstall later:"
echo "  executor uninstall --yes"
echo "  bash executor/uninstall --yes"
echo ""
show_star_prompt
